<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>关于android异步编程的学习</title></head><body>　　<div class="inner"><h2>关于android异步编程的学习</h2><h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>android中，对异步编程进行对比，进而选择最合适的实现方式</p>
<h1 id="模拟需求"><a href="#模拟需求" class="headerlink" title="模拟需求"></a>模拟需求</h1><p>分别从宜家、家乐福获取商品桌子的信息，获取到后两者进行比较，挑选出最合意的桌子。依赖关系如下图所示。</p>
<p><img src="/images/async_code/Dependency.jpg" alt="Dependency"></p>
<p>UI效果图如下所示：</p>
<p><img src="/images/async_code/ui0.png" alt="ui0">      <img src="/images/async_code/ui1.png" alt="ui1"></p>
<p>大概业务逻辑是这样：</p>
<ol>
<li>在UI上分别显示：”正在请求宜家数据…”，”正在请求家乐福数据…”，”等待任务1和任务2…”;</li>
<li>开启异步任务，并发请求宜家数据和家乐福数据;</li>
<li>当宜家数据请求成功后，把商品信息显示在UI上;</li>
<li>当家乐福数据请求成功后，同时也把商品信息显示在UI上；</li>
<li>第3步和第4步没有先后顺序；</li>
<li>当第3步中的宜家数据和第4步中家乐福数据都请求下来后，开启新的异步任务，比较两家商品谁更好。同时在UI上显示：”开始比较”</li>
<li>有了比较结果后，把比较结果（哪家商品更好）显示到UI上。</li>
</ol>
<p>以下分别用基础的线程、线程池、java8支持的completefuture、rxjava、协程来实现。<br>需要注意的是，当用户取消任务（从当前activity返回）时，我们要去调用cancel方法。ikea表示宜家，carrefour表示家乐福,goods表示商品(这里我们用买桌子来做比喻)。</p>
<blockquote>
<blockquote>
<p>博客所引用到的代码:<a href="https://github.com/sunhang/AsyncTaskDemo" target="_blank" rel="noopener">https://github.com/sunhang/AsyncTaskDemo</a></p>
</blockquote>
</blockquote>
<h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><p>用最基础的线程Thread来实现。需要注意如下几点：</p>
<ul>
<li>cancel时，需要调用Thread的interrupt方法，同时设置标记量canceled为true</li>
<li>线程中捕获InterruptedException，检查标记量canceled</li>
<li>uiTask中判断ikeaGoods和carrefourGoods是否都具备了，否则不可以去调用betterGoods去做商品比较</li>
<li>canceled没有被标记为@Volatile，因为目前只在主线程中访问了canceled</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestServer</span><span class="params">()</span></span> &#123;</span><br><span class="line">    view.displayIKEAGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayCarrefourGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayBetterGoods(Resource(Resource.WAITING))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ikeaGoods: Goods? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> carrefourGoods: Goods? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> uiTask = &#123; action: () -&gt; <span class="built_in">Unit</span> -&gt;</span><br><span class="line">        mainThreadHandler.post &#123;</span><br><span class="line">            <span class="keyword">if</span> (canceled) <span class="keyword">return</span><span class="symbol">@post</span></span><br><span class="line"></span><br><span class="line">            action()</span><br><span class="line">            safeLet(ikeaGoods, carrefourGoods) &#123; it0, it1 -&gt;</span><br><span class="line">                betterGoods(it0, it1)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    threads += Thread &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> goods = backendWork.getGoodsFromIKEA()</span><br><span class="line">            uiTask &#123;</span><br><span class="line">                ikeaGoods = goods</span><br><span class="line">                view.displayIKEAGoods(Resource(Resource.FINISH, goods))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: InterruptedException) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> currentThread = Thread.currentThread()</span><br><span class="line">            mainThreadHandler.post &#123;</span><br><span class="line">                threads -= currentThread</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.apply &#123; start() &#125;</span><br><span class="line"></span><br><span class="line">    threads += Thread &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> goods = backendWork.getGoodsFromCarrefour()</span><br><span class="line">            uiTask &#123;</span><br><span class="line">                carrefourGoods = goods</span><br><span class="line">                view.displayCarrefourGoods(Resource(Resource.FINISH, goods))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: InterruptedException) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> currentThread = Thread.currentThread()</span><br><span class="line">            mainThreadHandler.post &#123;</span><br><span class="line">                threads -= currentThread</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.apply &#123; start() &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">betterGoods</span><span class="params">(ikeaGoods: <span class="type">Goods</span>, carrefourGoods: <span class="type">Goods</span>)</span></span> &#123;</span><br><span class="line">    view.displayBetterGoods(Resource(Resource.LOADING))</span><br><span class="line"></span><br><span class="line">    threads += Thread &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> goods = backendWork.selectBetterOne(ikeaGoods, carrefourGoods)</span><br><span class="line"></span><br><span class="line">            mainThreadHandler.post &#123;</span><br><span class="line">                <span class="keyword">if</span> (canceled) <span class="keyword">return</span><span class="symbol">@post</span></span><br><span class="line"></span><br><span class="line">                view.displayBetterGoods(Resource(Resource.FINISH, goods))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: InterruptedException) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> currentThread = Thread.currentThread()</span><br><span class="line">            mainThreadHandler.post &#123;</span><br><span class="line">                threads -= currentThread</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.apply &#123; start() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="cancel"><a href="#cancel" class="headerlink" title="cancel"></a>cancel</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    canceled = <span class="literal">true</span></span><br><span class="line">    threads.forEach &#123; it.interrupt() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过，android直接用Thread做异步任务的实现，已经很少了。它本身更容易出错，而且难度大一些，要去理清同步互斥，锁的操作等。</p>
<h1 id="thread-pool"><a href="#thread-pool" class="headerlink" title="thread pool"></a>thread pool</h1><p>android开发，经常要直接接触线程池的使用和设计。针对上边的业务需求，这个是使用线程池的实现版本。<br>我们用到了<code>ikeaFuture.get()</code>和<code>carrefourFuture.get()</code>，用于模拟等待任务1和任务2。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestServer</span><span class="params">()</span></span> &#123;</span><br><span class="line">    view.displayIKEAGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayCarrefourGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayBetterGoods(Resource(Resource.WAITING))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ikeaFuture = backendExecutor.submit&lt;Goods&gt; &#123;</span><br><span class="line">        backendWork.getGoodsFromIKEA().alsoPostToUI &#123;</span><br><span class="line">            view.displayIKEAGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> carrefourFuture = backendExecutor.submit&lt;Goods&gt; &#123;</span><br><span class="line">        backendWork.getGoodsFromCarrefour().alsoPostToUI &#123;</span><br><span class="line">            view.displayCarrefourGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    backendExecutor.submit&lt;Goods&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> ikeaGoods = ikeaFuture.<span class="keyword">get</span>()</span><br><span class="line">        <span class="keyword">val</span> carrefourGoods = carrefourFuture.<span class="keyword">get</span>()</span><br><span class="line"></span><br><span class="line">        mainHandler.post &#123;</span><br><span class="line">            view.displayBetterGoods(</span><br><span class="line">                Resource(</span><br><span class="line">                    Resource.LOADING,</span><br><span class="line">                    <span class="string">"start compare which one is better"</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        backendWork.selectBetterOne(ikeaGoods, carrefourGoods).alsoPostToUI &#123;</span><br><span class="line">            view.displayBetterGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> Goods.<span class="title">alsoPostToUI</span><span class="params">(task: (<span class="type">Goods</span>)</span></span> -&gt; <span class="built_in">Unit</span>): Goods &#123;</span><br><span class="line">    mainHandler.post &#123;</span><br><span class="line">        task(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="cancel-1"><a href="#cancel-1" class="headerlink" title="cancel"></a>cancel</h2><p>需要调用线程池的shutdownNow，这里没有调用shutdown。shutdownNow不仅取消了等待队列中的任务，而且对正在执行的任务也会通知interrupt。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    backendExecutor.shutdownNow()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="future"><a href="#future" class="headerlink" title="future"></a>future</h2><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h1 id="completefuture"><a href="#completefuture" class="headerlink" title="completefuture"></a>completefuture</h1><p>java8开始支持CompletableFuture，不过要在android N及更高的版本才支持。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestServer</span><span class="params">()</span></span> &#123;</span><br><span class="line">    view.displayIKEAGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayCarrefourGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayBetterGoods(Resource(Resource.WAITING))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ikeaFuture = CompletableFuture.supplyAsync(Supplier &#123;</span><br><span class="line">        backendWork.getGoodsFromIKEA()</span><br><span class="line">    &#125;, backendExecutor).apply &#123;</span><br><span class="line">        thenAcceptAsync(Consumer &#123;</span><br><span class="line">            view.displayIKEAGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;, mainThreadExecutor)</span><br><span class="line"></span><br><span class="line">        futures += <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> carrefourFuture = CompletableFuture.supplyAsync(Supplier &#123;</span><br><span class="line">        backendWork.getGoodsFromCarrefour()</span><br><span class="line">    &#125;, backendExecutor).apply &#123;</span><br><span class="line">        thenAcceptAsync(Consumer &#123;</span><br><span class="line">            view.displayCarrefourGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;, mainThreadExecutor)</span><br><span class="line"></span><br><span class="line">        futures += <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    futures += ikeaFuture.thenCombineAsync(</span><br><span class="line">        carrefourFuture,</span><br><span class="line">        BiFunction&lt;Goods, Goods, Pair&lt;Goods, Goods&gt;&gt; &#123; g0, g1 -&gt;</span><br><span class="line">            view.displayBetterGoods(Resource(Resource.LOADING))</span><br><span class="line">            Pair(g0, g1)</span><br><span class="line">        &#125;,</span><br><span class="line">        mainThreadExecutor</span><br><span class="line">    ).thenApplyAsync(java.util.function.Function&lt;Pair&lt;Goods, Goods&gt;, Goods&gt; &#123;</span><br><span class="line">        backendWork.selectBetterOne(it.first, it.second)</span><br><span class="line">    &#125;, backendExecutor).thenAcceptAsync(Consumer&lt;Goods&gt; &#123;</span><br><span class="line">        view.displayBetterGoods(Resource(Resource.FINISH, it))</span><br><span class="line">    &#125;, mainThreadExecutor)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    futures.forEach &#123;</span><br><span class="line">        it.cancel(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="supply"><a href="#supply" class="headerlink" title="supply"></a>supply</h2><h2 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h2><h2 id="accept"><a href="#accept" class="headerlink" title="accept"></a>accept</h2><h1 id="rxjava"><a href="#rxjava" class="headerlink" title="rxjava"></a>rxjava</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestServer</span><span class="params">()</span></span> &#123;</span><br><span class="line">    view.displayIKEAGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayCarrefourGoods(Resource(Resource.LOADING))</span><br><span class="line">    view.displayBetterGoods(Resource(Resource.WAITING))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ikeaObservable = goodsModel.getGoodsFromIKEAAsync()</span><br><span class="line">        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">        .doOnNext &#123;</span><br><span class="line">            view.displayIKEAGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> carrefourObservable = goodsModel.getGoodsFromCarrefourAsync()</span><br><span class="line">        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">        .doOnNext &#123;</span><br><span class="line">            view.displayCarrefourGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    compositeDisposable += Observable.zip(</span><br><span class="line">        ikeaObservable,</span><br><span class="line">        carrefourObservable,</span><br><span class="line">        BiFunction &#123; t1: Goods, t2: Goods -&gt;</span><br><span class="line">            view.displayBetterGoods(Resource(Resource.LOADING))</span><br><span class="line">            Pair(t1, t2)</span><br><span class="line">        &#125;).flatMap &#123;</span><br><span class="line">        goodsModel.selectBetterOneAsync(it.first, it.second)</span><br><span class="line">    &#125;.observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            view.displayBetterGoods(Resource(Resource.FINISH, it))</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    compositeDisposable.dispose()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><h2 id="异常处理-1"><a href="#异常处理-1" class="headerlink" title="异常处理"></a>异常处理</h2><h1 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h1><p>协程（Coroutines）是一种比线程更加轻量级的存在，正如一个进程可以拥有多个线程一样，一个线程可以拥有多个协程。进程切换和线程切换是系统级的，发生在操作系统内部。协程切换是用户级的，切换时机是用户自己的程序决定的。</p>
<p>如下是用协程实现的一个版本：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestServer</span><span class="params">()</span></span> &#123;</span><br><span class="line">    uiScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> deferredIKEAGoods = goodsModel.getGoodsFromIKEAAsync()</span><br><span class="line">        <span class="keyword">val</span> deferredCarrefourGoods = goodsModel.getGoodsFromCarrefourAsync()</span><br><span class="line"></span><br><span class="line">        view.displayIKEAGoods(Resource(Resource.LOADING))</span><br><span class="line">        view.displayCarrefourGoods(Resource(Resource.LOADING))</span><br><span class="line"></span><br><span class="line">        launch &#123;</span><br><span class="line">            <span class="keyword">val</span> goods = deferredIKEAGoods.await()</span><br><span class="line">            view.displayIKEAGoods(Resource(Resource.FINISH, goods))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        launch &#123;</span><br><span class="line">            <span class="keyword">val</span> goods = deferredCarrefourGoods.await()</span><br><span class="line">            view.displayCarrefourGoods(Resource(Resource.FINISH, goods))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        view.displayBetterGoods(Resource(Resource.WAITING))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> ikeaGoods = deferredIKEAGoods.await()</span><br><span class="line">        <span class="keyword">val</span> carrefourGoods = deferredCarrefourGoods.await()</span><br><span class="line"></span><br><span class="line">        view.displayBetterGoods(Resource(Resource.LOADING))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> betterGoods = goodsModel.selectBetterOneAsync(supervisorJob, ikeaGoods, carrefourGoods).await()</span><br><span class="line">        view.displayBetterGoods(Resource(Resource.FINISH, betterGoods))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    supervisorJob.cancel()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="协程相关类的介绍"><a href="#协程相关类的介绍" class="headerlink" title="协程相关类的介绍"></a>协程相关类的介绍</h2><p>什么是协程上下文？ CoroutineContext包含了协程运行时的一些信息。根据文档里的说明，CoroutineContext 的概念主要有3点：</p>
<ol>
<li>It is an indexed set of [Element] instances. 它是一个包含 Element 实例的索引集；</li>
<li>An indexed set is a mix between a set and a map. 索引集是 set 和 map 的混合结构；</li>
<li>Every element in this set has a unique [Key]. 这个集合中的每个元素都有一个唯一的 Key；</li>
</ol>
<p>说的通俗一点，CoroutineContext 就是一个集合 Collection，这个集合既有 set 的特性又有 map 的特性，集合里的元素都是 Element 类型的，每个 Element 类型的元素都有一个类型为 Key 的键。具体看它的源码时，发现它内部即没有数组也没有链表，它这个数据结构是采用函数式风格来实现的（left-biased list的context）。</p>
<p>context、job、拦截器的类关系如下图所示。<br><img src="/images/async_code/xiecheng.png" alt=""></p>
<p>拦截器是什么？拦截器也是一个上下文的实现，拦截器可以左右你的协程的执行，同时为了保证它的功能的正确性，协程上下文集合永远将它放在最后面，这真可谓是天选之子了。</p>
<p>kotlin对拦截器的定义如下<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ContinuationInterceptor</span> : <span class="type">CoroutineContext.Element &#123;</span></span></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> Key : CoroutineContext.Key&lt;ContinuationInterceptor&gt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">interceptContinuation</span><span class="params">(continuation: <span class="type">Continuation</span>&lt;<span class="type">T</span>&gt;)</span></span>: Continuation&lt;T&gt;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调度器是什么？它本身是协程上下文的子类，同时实现了拦截器的接口， dispatch 方法会在拦截器的方法 interceptContinuation 中调用，进而实现协程的调度。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CoroutineDispatcher</span> :<span class="type"></span></span></span><br><span class="line">    AbstractCoroutineContextElement(ContinuationInterceptor), ContinuationInterceptor &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatch</span><span class="params">(context: <span class="type">CoroutineContext</span>, block: <span class="type">Runnable</span>)</span></span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>举例说明调度器的创建<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">suspend <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> myDispatcher= Executors.newSingleThreadExecutor&#123; r -&gt; Thread(r, <span class="string">"MyThread"</span>) &#125;.asCoroutineDispatcher()</span><br><span class="line">    GlobalScope.launch(myDispatcher) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;.join()</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以通过主动关闭线程池或者调用<code>myDispatcher.close()</code>来结束它的生命周期</p>
<p>GlobleScope和CoroutineScope的区别是什么？<br>runblock和launch的区别是什么？</p>
<h2 id="协程异常处理"><a href="#协程异常处理" class="headerlink" title="协程异常处理"></a>协程异常处理</h2><h2 id="协程取消"><a href="#协程取消" class="headerlink" title="协程取消"></a>协程取消</h2><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><ul>
<li>CompletableFuture虽然早已被java8支持，但是只能在android N及更高版本才可以使用；</li>
<li>使用thread做异步的业务逻辑处理，虽然操作的粒度很细，但是要照顾的细节太多，还要理清锁和同步互斥，开发效率并不会提高；</li>
<li>若使用线程池，对于任务的依赖关系只能用简单的future的get来处理，实现任务依赖的能力过于单薄；</li>
<li>rxjava的代码量相对就少很多，对依赖关系处理能力强，可以轻松进行线程切换，若条件允许，建议使用rxjava；</li>
<li>kotlin通过扩展包的方式支持了协程，可是在android上java还不支持协程。在纯kotlin项目中，相对rxjava，协程更轻量级，异步任务处理能力也挺强；</li>
<li>但是若是在java+kotlin混合项目中，协程则不能充分应用到项目工程所有地方(仅在kotlin代码中使用)。此时为了工程保持接口统一，也可能需要放弃使用协程了。</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://www.jianshu.com/p/2d2e21941461" target="_blank" rel="noopener">https://www.jianshu.com/p/2d2e21941461</a></li>
<li><a href="https://www.jianshu.com/p/06703abc56b1" target="_blank" rel="noopener">https://www.jianshu.com/p/06703abc56b1</a></li>
<li>协程<a href="https://www.bennyhuo.com/2019/04/11/coroutine-dispatchers/" target="_blank" rel="noopener">https://www.bennyhuo.com/2019/04/11/coroutine-dispatchers/</a></li>
</ul>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>